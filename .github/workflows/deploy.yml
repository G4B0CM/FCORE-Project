name: Deploy FCORE Monorepo

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  # Job 1: Build y Test (Integración Continua)
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python 3.9
        uses: actions/setup-python@v4
        with:
          python-version: "3.9"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          # Instalar dependencias del proyecto y de pruebas
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          pip install pytest pytest-mock pytest-cov httpx

      - name: Run Tests
        # Ejecuta pytest y falla si algún test no pasa
        run: |
          pytest tests/ -v --cov=fcore --cov-fail-under=70
        env:
          # Variables fake para que no falle config si las usa
          SECRET_KEY: "testing_key"
          ALGORITHM: "HS256"

  # Job 2: Deploy (Entrega Continua) - Solo corre si 'test' pasa
  deploy:
    needs: test # Dependencia explícita: si test falla, deploy no corre
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          command_timeout: 30m 
          script: |
            # 1. Crear carpeta del proyecto
            mkdir -p ~/FCORE
            cd ~/FCORE

            # 2. Actualizar código
            if [ ! -d ".git" ]; then
              git clone https://github.com/${{ github.repository }}.git .
            else
              git fetch origin
              git reset --hard origin/main
            fi

            # 3. Crear archivo .env de Producción
            echo "${{ secrets.PROD_ENV_FILE }}" > .env

            # 4. Desplegar
            sudo docker compose -f compose.prod.yaml up -d --build --remove-orphans
            
            # 5. Limpieza
            sudo docker image prune -f