name: Deploy FCORE Monorepo

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  # ------------------------------------------------------------------
  # JOB 1: CI - Pruebas y Calidad
  # ------------------------------------------------------------------
  test:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./BE-FCORE

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python 3.13
        uses: actions/setup-python@v4
        with:
          python-version: "3.13"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          # Instalamos dependencias de prueba
          pip install pytest pytest-mock pytest-cov httpx

      - name: Run Tests
        # --- FIX: Agregamos PYTHONPATH=. para que encuentre el módulo 'fcore' ---
        run: |
          pytest tests/ -v --cov=fcore --cov-fail-under=70
        env:
          SECRET_KEY: "testing_key"
          ALGORITHM: "HS256"
          PYTHONPATH: .  # <--- ESTA LÍNEA ES LA SOLUCIÓN MÁGICA

  # ------------------------------------------------------------------
  # JOB 2: CD - Despliegue Continuo
  # ------------------------------------------------------------------
  deploy:
    needs: test
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          command_timeout: 30m 
          script: |
            # 1. Crear/Ir a carpeta raíz del proyecto
            mkdir -p ~/FCORE
            cd ~/FCORE

            # 2. Actualizar código
            if [ ! -d ".git" ]; then
              git clone https://github.com/${{ github.repository }}.git .
            else
              git fetch origin
              git reset --hard origin/main
            fi

            # 3. Entrar a la carpeta del Backend
            cd BE-FCORE

            # 4. Configurar entorno y desplegar
            echo "${{ secrets.PROD_ENV_FILE }}" > .env
            sudo docker compose -f compose.prod.yaml up -d --build --remove-orphans
            
            # 5. Limpieza
            sudo docker image prune -f